<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Or√ßamentos ‚Äî Eco Smart Group</title>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --radius-lg:20px;
      --radius-md:12px;
      --radius-sm:8px;

      --shadow-big-dark:0 24px 64px rgba(0,0,0,.6);
      --shadow-big-light:0 32px 64px rgba(0,0,0,.07);

      --shadow-card-dark:0 12px 32px rgba(0,0,0,.4);
      --shadow-card-light:0 8px 24px rgba(0,0,0,.08);

      --section-gap:16px;
      --card-padding:16px;
    }

    /* Tema escuro */
    body.theme-dark{
      --bg-body:#0b0d10;
      --bg-grad-start:#0b0d10;
      --bg-grad-end:#0c1014;

      --panel:#0f1317;
      --surface:#141922;
      --surface-hover:#1a212e;
      --input-bg:#0e1218;

      --txt-primary:#dde6ee;
      --txt-secondary:#9aa4b2;
      --txt-muted:#6b7380;
      --txt-soft-on-accent:#eafff0;

      --accent-main:#1b6e2a;
      --accent-alt:#13541f;
      --accent-soft:rgba(43,138,62,.15);

      --good:#6be28a;
      --warn:#ffd36b;
      --danger:#ef6b6b;

      --border:#1f2430;
      --border-strong:#2f384a;

      --brand-badge-bg:radial-gradient(circle at 20% 20%,#2b8a3e 0%,#1b6e2a 40%,#13541f 100%);
      --brand-badge-shadow:0 12px 32px rgba(38,108,52,.5);

      --header-bg:rgba(11,13,16,.7);
      --header-shadow:0 24px 48px rgba(0,0,0,.8);

      --card-bg-gradient:linear-gradient(
        160deg,
        rgba(20,25,34,.9) 0%,
        rgba(15,19,23,.6) 100%
      );
      --card-border-glow:radial-gradient(circle at 0% 0%,rgba(43,138,62,.35) 0%,rgba(0,0,0,0) 70%);

      --card-header-bg:linear-gradient(
        to right,
        rgba(27,110,42,.08) 0%,
        rgba(19,24,29,0) 60%
      );

      --footer-bg:rgba(15,19,23,.75);

      --shadow-big:var(--shadow-big-dark);
      --shadow-card:var(--shadow-card-dark);
    }

    /* Tema claro */
    body.theme-light{
      --bg-body:#f5f7fa;
      --bg-grad-start:#f5f7fa;
      --bg-grad-end:#eef2f6;

      --panel:#ffffff;
      --surface:#ffffff;
      --surface-hover:#f5f9f4;
      --input-bg:#ffffff;

      --txt-primary:#1a1f2a;
      --txt-secondary:#4a5568;
      --txt-muted:#7b8498;
      --txt-soft-on-accent:#ffffff;

      --accent-main:#1b6e2a;
      --accent-alt:#145323;
      --accent-soft:rgba(43,138,62,.12);

      --good:#1b6e2a;
      --warn:#b37a00;
      --danger:#c0392b;

      --border:#d4d9e3;
      --border-strong:#aeb7c9;

      --brand-badge-bg:radial-gradient(circle at 20% 20%,#2b8a3e 0%,#1b6e2a 40%,#13541f 100%);
      --brand-badge-shadow:0 8px 20px rgba(27,110,42,.25);

      --header-bg:rgba(255,255,255,.7);
      --header-shadow:0 24px 48px rgba(0,0,0,.06);

      --card-bg-gradient:linear-gradient(
        160deg,
        rgba(255,255,255,1) 0%,
        rgba(245,247,250,.8) 100%
      );
      --card-border-glow:radial-gradient(circle at 0% 0%,rgba(43,138,62,.18) 0%,rgba(255,255,255,0) 70%);

      --card-header-bg:linear-gradient(
        to right,
        rgba(27,110,42,.06) 0%,
        rgba(255,255,255,0) 60%
      );

      --footer-bg:rgba(255,255,255,.9);

      --shadow-big:var(--shadow-big-light);
      --shadow-card:var(--shadow-card-light);
    }

    *{box-sizing:border-box;-webkit-font-smoothing:antialiased}

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(circle at 20% 10%,rgba(34,120,52,.18) 0%,rgba(0,0,0,0) 60%),
        linear-gradient(180deg,var(--bg-grad-start) 0%,var(--bg-grad-end) 100%);
      background-color:var(--bg-body);
      color:var(--txt-primary);
    }

    /* HEADER */
    header{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--header-bg);
      backdrop-filter:blur(10px) saturate(140%);
      -webkit-backdrop-filter:blur(10px) saturate(140%);
      border-bottom:1px solid var(--border);
      box-shadow:var(--header-shadow);
    }

    .wrap-header{
      max-width:1280px;
      margin:0 auto;
      padding:16px 20px;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand-badge{
      min-width:40px;
      min-height:40px;
      border-radius:12px;
      background:var(--brand-badge-bg);
      box-shadow:var(--brand-badge-shadow);
      border:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      font-weight:600;
      color:var(--txt-soft-on-accent);
      letter-spacing:.04em;
      text-shadow:0 1px 2px rgba(0,0,0,.4);
    }

    .head-texts{display:flex;flex-direction:column;min-width:0}
    .app-name{font-size:15px;font-weight:600;color:var(--txt-primary);line-height:1.25;display:flex;flex-wrap:wrap;align-items:center;gap:8px}
    .app-name .dot{display:inline-block;width:4px;height:4px;background:var(--txt-secondary);border-radius:999px;opacity:.4}
    .subtitle{font-size:12px;line-height:1.3;color:var(--txt-secondary);font-weight:400}

    .header-right{margin-left:auto;display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .chip-status{background:var(--input-bg);border:1px solid var(--border);color:var(--txt-primary);font-size:12px;line-height:1.2;padding:8px 10px;border-radius:var(--radius-md);display:flex;align-items:center;gap:6px;font-weight:500;box-shadow:var(--shadow-card)}
    .chip-status .dot-online{width:8px;height:8px;border-radius:999px;background:var(--good);box-shadow:0 0 8px var(--good)}

    .theme-toggle-btn{background:var(--input-bg);border:1px solid var(--border);border-radius:var(--radius-md);box-shadow:var(--shadow-card);color:var(--txt-primary);font-size:12px;font-weight:600;line-height:1.2;padding:8px 10px;cursor:pointer;display:flex;align-items:center;gap:6px;min-width:max-content}
    .theme-toggle-btn:hover{background:var(--surface-hover);border-color:var(--accent-main);box-shadow:0 16px 40px rgba(0,0,0,.2),0 0 12px rgba(43,138,62,.4)}

    /* GRID PRINCIPAL */
    .page{width:100%;max-width:1280px;margin:24px auto 96px auto;padding:0 20px 80px;flex:1;display:grid;gap:var(--section-gap)}
    @media(min-width:1080px){
      .page{grid-template-columns:minmax(0,1fr) 320px;align-items:start}
    }
    .main-col{display:grid;gap:var(--section-gap)}

    /* CARD */
    .card{position:relative;background:var(--card-bg-gradient);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-big);overflow:hidden}
    .card::before{
      content:"";position:absolute;inset:0;border-radius:inherit;padding:1px;background:var(--card-border-glow);
      -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none
    }
    .card-header{display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;gap:8px 12px;padding:16px var(--card-padding) 12px;border-bottom:1px solid var(--border);background:var(--card-header-bg)}
    .card-title-wrap{display:flex;flex-direction:column;gap:4px;min-width:0}
    .card-eyebrow{display:inline-flex;align-items:center;font-size:10px;line-height:1.2;font-weight:600;color:var(--accent-main);background:var(--accent-soft);border:1px solid rgba(27,110,42,.4);border-radius:var(--radius-sm);padding:3px 6px;width:max-content;text-transform:uppercase;letter-spacing:.08em}
    .card-title{font-size:14px;font-weight:600;line-height:1.4;color:var(--txt-secondary);text-transform:uppercase;letter-spacing:.12em}
    .card-desc{font-size:12px;line-height:1.4;color:var(--txt-secondary);font-weight:400;max-width:560px}
    .card-body{padding:16px var(--card-padding) 20px;display:grid;gap:16px}

    /* GRID DE CAMPOS */
    .row{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:760px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}

    /* INPUTS */
    .field{display:flex;flex-direction:column}
    .field-label{font-size:12px;font-weight:500;color:var(--txt-secondary);margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .field-label small{color:var(--txt-muted);font-weight:400;font-size:11px;line-height:1.2}
    .input-shell{position:relative;display:flex;align-items:center;background:var(--input-bg);border:1px solid var(--border);border-radius:var(--radius-md);box-shadow:var(--shadow-card);transition:border .15s, box-shadow .15s, background .15s}
    .input-shell:focus-within{border-color:var(--accent-main);box-shadow:0 0 0 4px var(--accent-soft),0 20px 32px rgba(0,0,0,.15)}
    .input-shell input,.input-shell select{width:100%;background:transparent;color:var(--txt-primary);font-size:14px;line-height:1.4;font-weight:500;border:0;outline:none;padding:10px 12px;border-radius:var(--radius-md);appearance:none}

    /* BLOCOS DE VALOR */
    .stat-box{background:var(--input-bg);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 12px;font-size:13px;line-height:1.4;color:var(--txt-primary);display:flex;flex-direction:column;gap:4px;min-height:56px;box-shadow:var(--shadow-card)}
    .stat-label{color:var(--txt-muted);font-size:11px;line-height:1.3;font-weight:400}
    .stat-value{font-size:14px;font-weight:600;line-height:1.3;word-break:break-word;color:var(--txt-primary);text-shadow:none}
    .stat-value.good{color:var(--good);text-shadow:0 0 8px rgba(107,226,138,.4)}

    /* NOTAS */
    .note{font-size:12px;line-height:1.4;color:var(--txt-secondary);font-weight:400;display:flex;flex-wrap:wrap;gap:6px}
    .note strong{font-weight:600;color:var(--txt-primary)}

    /* A√á√ïES */
    .actions-row{display:flex;flex-wrap:wrap;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--txt-primary);padding:10px 12px;border-radius:var(--radius-md);cursor:pointer;font-weight:600;font-size:13px;line-height:1.3;box-shadow:var(--shadow-card);transition:all .15s}
    .btn:hover{background:var(--surface-hover);border-color:var(--accent-main);box-shadow:0 16px 40px rgba(0,0,0,.2),0 0 12px rgba(43,138,62,.4)}
    .btn.primary{background:linear-gradient(180deg,var(--accent-main) 0%,var(--accent-alt) 100%);border-color:#1e6d2b;color:var(--txt-soft-on-accent);text-shadow:0 1px 2px rgba(0,0,0,.6)}
    .btn.primary:hover{box-shadow:0 16px 40px rgba(0,0,0,.3),0 0 16px rgba(43,138,62,.5)}
    .btn[data-icon="save"]::before{content:"üíæ";}.btn[data-icon="pdf"]::before{content:"üìÑ";}.btn[data-icon="link"]::before{content:"üîó";}.btn[data-icon="wa"]::before{content:"üì≤"}

    /* ASIDE */
    aside{display:grid;gap:var(--section-gap)}
    @media(min-width:1080px){aside{position:sticky;top:88px;align-self:start}}

    /* FOOTER TOTAL */
    .footerbar{position:fixed;bottom:0;left:0;right:0;background:var(--footer-bg);backdrop-filter:blur(10px) saturate(140%);-webkit-backdrop-filter:blur(10px) saturate(140%);border-top:1px solid var(--border);box-shadow:0 -24px 48px rgba(0,0,0,.4);z-index:60}
    body.theme-light .footerbar{box-shadow:0 -24px 48px rgba(0,0,0,.07)}
    .footer-inner{max-width:1280px;margin:0 auto;padding:12px 20px;display:flex;flex-wrap:wrap;justify-content:flex-end}
    .footer-total{background:var(--input-bg);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 12px;box-shadow:var(--shadow-card);font-size:13px;line-height:1.4;color:var(--txt-primary);display:flex;flex-direction:column;min-width:200px}
    .footer-total-label{font-size:11px;color:var(--txt-muted);line-height:1.3;font-weight:400}
    .footer-total-value{font-size:14px;font-weight:600;line-height:1.3;color:var(--good);text-shadow:0 0 8px rgba(107,226,138,.4);word-break:break-word}

    /* ===== Lista de custos adicionais (Etapa 6) ===== */
    .extra-costs-list{display:grid;gap:8px}
    .cost-item{
      display:grid;
      grid-template-columns:1fr 160px 120px 36px;
      gap:8px;align-items:center;
      background:var(--input-bg);border:1px solid var(--border);border-radius:var(--radius-md);
      padding:8px 10px;box-shadow:var(--shadow-card)
    }
    .cost-item .c-desc{color:var(--txt-primary);font-size:13px;font-weight:500;word-break:break-word}
    .cost-item .c-obs{color:var(--txt-muted);font-size:12px;word-break:break-word}
    .cost-item .c-price{font-weight:700;font-size:13px;text-align:right}
    .del-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--surface);cursor:pointer}
    .del-btn:hover{background:var(--surface-hover);border-color:var(--danger)}
  </style>
</head>

<body class="theme-dark">
  <!-- HEADER -->
  <header>
    <div class="wrap-header">
      <div class="brand-badge" aria-hidden>Eco</div>

      <div class="head-texts">
        <div class="app-name">
          <span>Calculadora de Or√ßamentos</span>
          <span class="dot"></span>
          <span>EcoSmart Group</span>
        </div>
        <div class="subtitle">Custos t√©cnicos, taxa de servi√ßo, margem e total final ‚Äî tudo em um s√≥ lugar.</div>
      </div>

      <div class="header-right">
        <div class="chip-status">
          <span class="dot-online"></span>
          <span id="status">Conectado ao Supabase</span>
        </div>

        <button class="theme-toggle-btn" id="themeToggleBtn">
          <span id="themeIcon">üåô</span>
          <span id="themeLabel">Escuro</span>
        </button>
      </div>
    </div>
  </header>

  <!-- CONTE√öDO -->
  <main class="page">
    <div class="main-col">

      <!-- TRANSPORTE -->
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Etapa 1</span>
            <div class="card-title">Transporte</div>
            <div class="card-desc">
              Combust√≠vel, autonomia do ve√≠culo e dist√¢ncia total percorrida no deslocamento de campo.
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row cols-3">
            <div class="field">
              <label class="field-label">Custo do combust√≠vel por litro (R$)</label>
              <div class="input-shell"><input id="combustivel_preco" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Autonomia (km/l)</label>
              <div class="input-shell"><input id="autonomia" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Dist√¢ncia total (km)</label>
              <div class="input-shell"><input id="dist_total" type="text" value="0"></div>
            </div>
          </div>

          <div class="note">Subtotal Transporte: <strong id="sub_transporte">R$ 0,00</strong></div>
        </div>
      </section>

      <!-- M√ÉO DE OBRA -->
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Etapa 2</span>
            <div class="card-title">M√£o de Obra</div>
            <div class="card-desc">Horas de campo e de escrit√≥rio necess√°rias para executar e consolidar o trabalho.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="row cols-2">
            <div class="field">
              <label class="field-label">Valor por hora de campo (R$)</label>
              <div class="input-shell"><input id="vh_campo" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Horas de campo</label>
              <div class="input-shell"><input id="h_campo" type="text" value="0"></div>
            </div>
          </div>

          <div class="row cols-2">
            <div class="field">
              <label class="field-label">Valor por hora de escrit√≥rio (R$)</label>
              <div class="input-shell"><input id="vh_escr" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Horas de escrit√≥rio</label>
              <div class="input-shell"><input id="h_escr" type="text" value="0"></div>
            </div>
          </div>

          <div class="note">Subtotal M√£o de Obra: <strong id="sub_mao">R$ 0,00</strong></div>
        </div>
      </section>

      <!-- AN√ÅLISES -->
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Etapa 3</span>
            <div class="card-title">An√°lises</div>
            <div class="card-desc">Custos laboratoriais por amostra e total de amostras previstas.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="row cols-2">
            <div class="field">
              <label class="field-label">Valor por amostra (R$)</label>
              <div class="input-shell"><input id="v_amostra" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">N√∫mero de amostras</label>
              <div class="input-shell"><input id="n_amostras" type="text" value="0"></div>
            </div>
          </div>

          <div class="note">Subtotal An√°lises: <strong id="sub_analises">R$ 0,00</strong></div>
        </div>
      </section>

      <!-- VARI√ÅVEIS ADICIONAIS -->
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Etapa 4</span>
            <div class="card-title">Vari√°veis Adicionais</div>
            <div class="card-desc">Custos de di√°ria, alojamento, alimenta√ß√£o, ART, voo de drone e assinatura anual.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="row cols-3">
            <div class="field">
              <label class="field-label">üí∞ Di√°rias de campo (R$)</label>
              <div class="input-shell"><input id="diaria" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">üìÖ Quantidade de dias</label>
              <div class="input-shell"><input id="dias" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">üë• N√∫mero de pessoas</label>
              <div class="input-shell"><input id="pessoas" type="text" value="0"></div>
            </div>
          </div>

          <div class="row cols-3">
            <div class="field">
              <label class="field-label">üè® Alojamento por pessoa (R$)</label>
              <div class="input-shell"><input id="aloj" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">üçΩ Alimenta√ß√£o por pessoa (R$)</label>
              <div class="input-shell"><input id="alim" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">üìã ART - valor (R$)</label>
              <div class="input-shell"><input id="art_valor" type="text" value="0"></div>
            </div>
          </div>

          <div class="row cols-3">
            <div class="field">
              <label class="field-label">üìã ART - quantidade</label>
              <div class="input-shell"><input id="art_qtd" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">üì° Drone LIDAR/Multiespectral/RGB - hectares</label>
              <div class="input-shell"><input id="drone_ha" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">üíµ Pre√ßo por hectare (R$)</label>
              <div class="input-shell"><input id="preco_ha" type="text" value="0"></div>
            </div>
          </div>

          <div class="row cols-2">
            <div class="field">
              <label class="field-label">
                ‚öô Fator de complexidade do terreno
                <small>aplicado s√≥ ao custo de drone</small>
              </label>
              <div class="input-shell">
                <select id="fator">
                  <option value="1">Sem fator</option>
                  <option value="1.2">1,2 - M√©dia complexidade</option>
                  <option value="1.5">1,5 - Alta complexidade</option>
                  <option value="1.8">1,8 - Muito alta complexidade</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="field-label">
                üìù Assinatura de 1 ano ‚Äî pre√ßo mensal (R$)
                <small>Plataforma / monitoramento</small>
              </label>
              <div class="input-shell"><input id="assin_mensal" type="text" value="0"></div>
            </div>
          </div>

          <div class="note">Subtotal Vari√°veis Adicionais: <strong id="sub_var">R$ 0,00</strong></div>
        </div>
      </section>

      <!-- ACR√âSCIMOS / IMPOSTOS / MARGEM -->
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Etapa 5</span>
            <div class="card-title">Acr√©scimos / Impostos / Margem</div>
            <div class="card-desc">Percentuais que incidem sobre a base.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="row cols-3">
            <div class="field">
              <label class="field-label">Emiss√£o de Nota Fiscal (%)</label>
              <div class="input-shell"><input id="p_nf" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Presta√ß√£o de Servi√ßos (%)</label>
              <div class="input-shell"><input id="p_serv" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Impostos e Taxas (%)</label>
              <div class="input-shell"><input id="p_tax" type="text" value="0"></div>
            </div>
          </div>

          <div class="row cols-3">
            <div class="field">
              <label class="field-label">Taxa Administrativa (%)</label>
              <div class="input-shell"><input id="p_admin" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Outros Custos (R$)</label>
              <div class="input-shell"><input id="outros" type="text" value="0"></div>
            </div>
            <div class="field">
              <label class="field-label">Margem de Lucro (%)</label>
              <div class="input-shell"><input id="p_margem" type="text" value="0"></div>
            </div>
          </div>

          <div class="row cols-2">
            <div class="stat-box">
              <div class="stat-label">Base de C√°lculo (Base √ó Fator aplicado no drone)</div>
              <div class="stat-value" id="base_calc">R$ 0,00</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Total com Acr√©scimos (antes da margem)</div>
              <div class="stat-value" id="total_acresc">R$ 0,00</div>
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOS ADICIONAIS (ETAPA 6) -->
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Etapa 6</span>
            <div class="card-title">Custos Adicionais</div>
            <div class="card-desc">Adicione custos extra (di√°rias, aluguel, taxas etc.).</div>
          </div>
        </div>
        <div class="card-body">
          <div class="row cols-3">
            <div class="field">
              <label class="field-label">Descrever o custo</label>
              <div class="input-shell"><input id="ec_desc" type="text" placeholder="Ex.: Aluguel de caminhonete"></div>
            </div>
            <div class="field">
              <label class="field-label">Pre√ßo (R$)</label>
              <div class="input-shell"><input id="ec_preco" type="text" placeholder="Ex.: 1.200,00"></div>
            </div>
            <div class="field">
              <label class="field-label">Observa√ß√µes</label>
              <div class="input-shell"><input id="ec_obs" type="text" placeholder="Ex.: 3 di√°rias"></div>
            </div>
          </div>
          <div class="actions-row">
            <button class="btn" id="btnAddCost" data-icon="save">Adicionar custo</button>
          </div>

          <div id="extraCostsList" class="extra-costs-list" aria-live="polite"></div>

          <div class="note">Subtotal Custos Adicionais: <strong id="sub_extra">R$ 0,00</strong></div>
        </div>
      </section>

      <!-- RESUMO -->
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Resumo</span>
            <div class="card-title">Vis√£o Geral do Or√ßamento</div>
            <div class="card-desc">Totais por etapa e valor final.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="row cols-4">
            <div class="stat-box"><div class="stat-label">üöó Transporte</div><div class="stat-value" id="r_transporte">R$ 0,00</div></div>
            <div class="stat-box"><div class="stat-label">üë∑‚Äç‚ôÇÔ∏è M√£o de Obra</div><div class="stat-value" id="r_mao">R$ 0,00</div></div>
            <div class="stat-box"><div class="stat-label">üß™ An√°lises</div><div class="stat-value" id="r_analises">R$ 0,00</div></div>
            <div class="stat-box"><div class="stat-label">‚öô Vari√°veis Adicionais</div><div class="stat-value" id="r_var">R$ 0,00</div></div>
          </div>

          <div class="row cols-3">
            <div class="stat-box"><div class="stat-label">Subtotal Base</div><div class="stat-value" id="sub_base">R$ 0,00</div></div>
            <div class="stat-box"><div class="stat-label">Base √ó Fator</div><div class="stat-value" id="base_x_fator">R$ 0,00</div></div>
            <div class="stat-box"><div class="stat-label">TOTAL DO OR√áAMENTO</div><div class="stat-value good" id="total_final">R$ 0,00</div></div>
          </div>

          <div class="actions-row">
            <button class="btn primary" id="btnSalvar" data-icon="save">Salvar</button>
            <button class="btn" id="btnPDF" data-icon="pdf">PDF</button>
            <button class="btn" id="btnShare" data-icon="link">Copiar link</button>
            <button class="btn" id="btnWhats" data-icon="wa">WhatsApp</button>
          </div>
        </div>
      </section>

    </div>

    <!-- ASIDE -->
    <aside>
      <section class="card">
        <div class="card-header">
          <div class="card-title-wrap">
            <span class="card-eyebrow">Ajuda</span>
            <div class="card-title">Como funciona</div>
            <div class="card-desc">Estrutura do or√ßamento e status.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="note">
            A base considera Transporte, M√£o de Obra, An√°lises, Vari√°veis Adicionais (com fator aplicado apenas ao custo de drone) e Custos Adicionais. Depois aplica acr√©scimos e margem.
          </div>
          <div class="stat-box"><div class="stat-label">Status</div><div class="stat-value" id="status2">online</div></div>
        </div>
      </section>
    </aside>
  </main>

  <!-- FOOTER TOTAL -->
  <footer class="footerbar">
    <div class="footer-inner">
      <div class="footer-total">
        <div class="footer-total-label">Total atual</div>
        <div class="footer-total-value" id="total_footer">R$ 0,00</div>
      </div>
    </div>
  </footer>

<script>
/* ==========================
   Tema claro/escuro
========================== */
const THEME_KEY = 'calc.theme.v1';
const bodyEl = document.body;
const themeBtn = document.getElementById('themeToggleBtn');
const themeIcon = document.getElementById('themeIcon');
const themeLabel = document.getElementById('themeLabel');

function applyTheme(theme){
  bodyEl.classList.remove('theme-dark','theme-light');
  bodyEl.classList.add(theme);
  if(theme === 'theme-light'){ themeIcon.textContent = '‚òÄÔ∏è'; themeLabel.textContent = 'Claro'; }
  else { themeIcon.textContent = 'üåô'; themeLabel.textContent = 'Escuro'; }
  localStorage.setItem(THEME_KEY, theme);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === 'theme-light' || saved === 'theme-dark'){ applyTheme(saved); return; }
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyTheme(prefersDark ? 'theme-dark' : 'theme-light');
}
themeBtn.addEventListener('click', ()=>{ applyTheme(bodyEl.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark'); });
initTheme();

/* ==========================
   Supabase client
========================== */
const supabaseUrl = 'https://lyzjznvxxvnpgwyyxcyw.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5emp6bnZ4eHZucGd3eXl4Y3l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjAzNjcsImV4cCI6MjA3MjQzNjM2N30.rRK4h5bVMNe7toXLh83KaYYtum01q9I0hIzHXlFHd78';
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ==========================
   Estado e utilidades
========================== */
const BRL = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'});
const fmt = v => BRL.format(v||0);

// Conversor num√©rico BR (aceita v√≠rgula decimal)
function n(v){
  if (typeof v === 'number') return v;
  let s = String(v || '0').trim();
  if (s.includes(',')) { s = s.replace(/\./g, ''); s = s.replace(/,/g, '.'); }
  else { s = s.replace(/ /g, ''); }
  const out = parseFloat(s);
  return isNaN(out) ? 0 : out;
}

function saveLS(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function loadLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def } catch{ return def } }

const I = {
  combustivel_preco: document.getElementById('combustivel_preco'),
  autonomia: document.getElementById('autonomia'),
  dist_total: document.getElementById('dist_total'),

  vh_campo: document.getElementById('vh_campo'),
  h_campo: document.getElementById('h_campo'),

  vh_escr: document.getElementById('vh_escr'),
  h_escr: document.getElementById('h_escr'),

  v_amostra: document.getElementById('v_amostra'),
  n_amostras: document.getElementById('n_amostras'),

  diaria: document.getElementById('diaria'),
  dias: document.getElementById('dias'),
  pessoas: document.getElementById('pessoas'),

  aloj: document.getElementById('aloj'),
  alim: document.getElementById('alim'),

  art_valor: document.getElementById('art_valor'),
  art_qtd: document.getElementById('art_qtd'),

  drone_ha: document.getElementById('drone_ha'),
  preco_ha: document.getElementById('preco_ha'),

  fator: document.getElementById('fator'),
  assin_mensal: document.getElementById('assin_mensal'),

  p_nf: document.getElementById('p_nf'),
  p_serv: document.getElementById('p_serv'),
  p_tax: document.getElementById('p_tax'),
  p_admin: document.getElementById('p_admin'),

  outros: document.getElementById('outros'),
  p_margem: document.getElementById('p_margem')
};

const O = {
  sub_transporte: document.getElementById('sub_transporte'),
  sub_mao: document.getElementById('sub_mao'),
  sub_analises: document.getElementById('sub_analises'),
  sub_var: document.getElementById('sub_var'),

  r_transporte: document.getElementById('r_transporte'),
  r_mao: document.getElementById('r_mao'),
  r_analises: document.getElementById('r_analises'),
  r_var: document.getElementById('r_var'),

  sub_base: document.getElementById('sub_base'),
  base_x_fator: document.getElementById('base_x_fator'),
  base_calc: document.getElementById('base_calc'),
  total_acresc: document.getElementById('total_acresc'),

  total_final: document.getElementById('total_final'),
  total_footer: document.getElementById('total_footer'),

  status: document.getElementById('status'),
  status2: document.getElementById('status2')
};

/* ====== Etapa 6: Custos Adicionais ====== */
let EXTRA_COSTS = []; // {desc, preco, obs}

const EI = {
  desc: document.getElementById('ec_desc'),
  preco: document.getElementById('ec_preco'),
  obs:  document.getElementById('ec_obs'),
  btnAdd: document.getElementById('btnAddCost'),
  list: document.getElementById('extraCostsList'),
  sub:  document.getElementById('sub_extra')
};

function renderExtraCosts(){
  if(!EI.list) return 0;
  EI.list.innerHTML = '';
  let total = 0;

  EXTRA_COSTS.forEach((item, idx)=>{
    const price = n(item.preco);
    total += price;
    const row = document.createElement('div');
    row.className = 'cost-item';
    row.innerHTML = `
      <div class="c-desc">${item.desc || '-'}</div>
      <div class="c-obs">${item.obs || '-'}</div>
      <div class="c-price">${fmt(price)}</div>
      <button class="del-btn" title="Excluir" data-del="${idx}">‚úï</button>
    `;
    EI.list.appendChild(row);
  });

  if(EI.sub) EI.sub.textContent = fmt(total);
  return total;
}

if (EI.btnAdd){
  EI.btnAdd.addEventListener('click', ()=>{
    const desc = (EI.desc.value || '').trim();
    const preco = n(EI.preco.value);
    const obs   = (EI.obs.value || '').trim();
    if(!desc){ alert('Descreva o custo.'); return; }
    if(preco <= 0){ alert('Informe um pre√ßo v√°lido.'); return; }
    EXTRA_COSTS.push({desc, preco, obs});
    EI.desc.value = ''; EI.preco.value = ''; EI.obs.value = '';
    saveLS('calc.extraCosts.v1', EXTRA_COSTS);
    recalc();
  });
}
if (EI.list){
  EI.list.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-del]');
    if(!btn) return;
    const i = parseInt(btn.getAttribute('data-del'),10);
    if(isNaN(i)) return;
    EXTRA_COSTS.splice(i,1);
    saveLS('calc.extraCosts.v1', EXTRA_COSTS);
    recalc();
  });
}

/* ==========================
   Snapshot
========================== */
function snapshot(){
  const s = {};
  Object.keys(I).forEach(k=> s[k] = I[k].value);
  s.extra_costs = EXTRA_COSTS;
  return s;
}
function applySnapshot(s){
  if(!s) return;
  Object.keys(I).forEach(k=>{ if(s[k]!==undefined) I[k].value = s[k]; });
  EXTRA_COSTS = Array.isArray(s.extra_costs) ? s.extra_costs : [];
  renderExtraCosts();
}

/* ==========================
   Recalcular tudo
========================== */
function recalc(){
  // TRANSPORTE
  const combustivel = n(I.combustivel_preco.value);
  const autonomia   = n(I.autonomia.value);
  const distancia   = n(I.dist_total.value);
  const litros = autonomia > 0 ? (distancia / autonomia) : 0;
  const subTransporte = litros * combustivel;

  // M√ÉO DE OBRA
  const subMao =
    n(I.vh_campo.value)*n(I.h_campo.value) +
    n(I.vh_escr.value)*n(I.h_escr.value);

  // AN√ÅLISES
  const subAnalises = n(I.v_amostra.value)*n(I.n_amostras.value);

  // VARI√ÅVEIS ADICIONAIS
  const fatorVal = n(I.fator.value) || 1;
  const totalDiarias = n(I.diaria.value)*n(I.dias.value)*n(I.pessoas.value);
  const totalAloj    = n(I.aloj.value)*n(I.dias.value)*n(I.pessoas.value);
  const totalAlim    = n(I.alim.value)*n(I.dias.value)*n(I.pessoas.value);
  const totalART     = n(I.art_valor.value)*n(I.art_qtd.value);

  const droneHa = n(I.drone_ha.value);
  const precoHa = n(I.preco_ha.value);
  const totalDrone = (droneHa * precoHa) * fatorVal; // fator s√≥ no drone

  const totalAssin   = n(I.assin_mensal.value)*12;

  const subVar = totalDiarias + totalAloj + totalAlim + totalART + totalDrone + totalAssin;

  // ETAPA 6
  const totalExtra = renderExtraCosts();

  // BASE (fator j√° aplicado ao drone)
  const subBase = subTransporte + subMao + subAnalises + subVar + totalExtra;
  const baseMultiplicada = subBase;

  // ACR√âSCIMOS
  const pSoma = (n(I.p_nf.value)+n(I.p_serv.value)+n(I.p_tax.value)+n(I.p_admin.value))/100;
  const outrosVal = n(I.outros.value);
  const acrescimos = baseMultiplicada * pSoma;

  // MARGEM
  const margem = (baseMultiplicada + acrescimos + outrosVal) * (n(I.p_margem.value)/100);

  // TOTAL
  const total = baseMultiplicada + acrescimos + outrosVal + margem;

  // OUTPUT
  O.sub_transporte.textContent = fmt(subTransporte);
  O.sub_mao.textContent        = fmt(subMao);
  O.sub_analises.textContent   = fmt(subAnalises);
  O.sub_var.textContent        = fmt(subVar);

  O.r_transporte.textContent   = fmt(subTransporte);
  O.r_mao.textContent          = fmt(subMao);
  O.r_analises.textContent     = fmt(subAnalises);
  O.r_var.textContent          = fmt(subVar);

  O.sub_base.textContent       = fmt(subBase);
  O.base_x_fator.textContent   = fmt(baseMultiplicada);
  O.base_calc.textContent      = fmt(baseMultiplicada);
  O.total_acresc.textContent   = fmt(baseMultiplicada + acrescimos);

  O.total_final.textContent    = fmt(total);
  O.total_footer.textContent   = fmt(total);

  saveLS('calc.ecosmart.v2', snapshot());

  return {
    subTransporte, subMao, subAnalises, subVar,
    totalExtra,
    subBase, baseMultiplicada, acrescimos,
    outros: outrosVal, margem, total
  };
}

// Recalcular em qualquer input
Object.values(I).forEach(inp=> inp.addEventListener('input', recalc));

/* ==========================
   Salvar no Supabase
========================== */
const btnSalvar = document.getElementById('btnSalvar');
btnSalvar.addEventListener('click', async ()=>{
  const r = recalc();
  const row = {
    slug: crypto.randomUUID().slice(0,8),
    cliente: null, contato: null, telefone: null, email: null,
    projeto: null, local: null, data_ref: null,
    parametros: snapshot(),
    itens: [
      {categoria:'transporte', total:r.subTransporte},
      {categoria:'mao_de_obra', total:r.subMao},
      {categoria:'analises', total:r.subAnalises},
      {categoria:'variaveis_adicionais', total:r.subVar},
      {categoria:'custos_adicionais', total:r.totalExtra}
    ],
    subtotal: r.subBase,
    impostos: r.acrescimos,
    markup: r.margem,
    total: r.total,
    observacoes: null
  };

  try{
    const { error } = await supabaseClient.from('orcamentos').insert(row);
    if(error){ console.error(error); alert('Erro ao salvar: '+error.message); return; }
    const url = new URL(window.location.href);
    url.searchParams.set('o', row.slug);
    history.replaceState(null,'', url);
    alert('Or√ßamento salvo! Link atualizado na barra do navegador.');
  }catch(err){
    console.error(err);
    alert('Erro inesperado ao salvar. Veja o console.');
  }
});

/* ==========================
   Carregar por slug (?o=xxxx)
========================== */
(async function loadBySlug(){
  const slug = new URLSearchParams(location.search).get('o');

  if(!slug) {
    // inicia zerado mas tenta recuperar extras do navegador
    EXTRA_COSTS = loadLS('calc.extraCosts.v1', []);
    renderExtraCosts();
    recalc();
    return;
  }

  try{
    const { data, error } = await supabaseClient
      .from('orcamentos')
      .select('*')
      .eq('slug', slug)
      .single();

    if(error){ console.warn('N√£o foi poss√≠vel carregar o or√ßamento:', error.message); }
    if(data && data.parametros){ applySnapshot(data.parametros); }
    recalc();
  }catch(e){
    console.warn(e);
    recalc();
  }
})();

/* ==========================
   Compartilhar link
========================== */
document.getElementById('btnShare').addEventListener('click', ()=>{
  const url = location.href;
  if(navigator.clipboard) navigator.clipboard.writeText(url);
  alert('Link copiado.');
});

/* ==========================
   WhatsApp
========================== */
document.getElementById('btnWhats').addEventListener('click', ()=>{
  const t = document.getElementById('total_final').textContent || '';
  const msg = encodeURIComponent(`Ol√°! Segue o or√ßamento: ${t}. Link: ${location.href}`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
});

/* ==========================
   Exportar PDF
========================== */
document.getElementById('btnPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});

  const pad=36; let y=pad; const r = recalc();

  doc.setFont('helvetica','bold'); doc.setFontSize(13);
  doc.text('EcoSmart Group ‚Äî Or√ßamento', pad, y); y+=18;

  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(`Transporte: ${fmt(r.subTransporte)}  |  M√£o de Obra: ${fmt(r.subMao)}  |  An√°lises: ${fmt(r.subAnalises)}  |  Vari√°veis: ${fmt(r.subVar)}  |  Extras: ${fmt(r.totalExtra)}`, pad, y); y+=16;
  doc.text(`Subtotal Base: ${fmt(r.subBase)}  |  Base √ó Fator (drone aplicado): ${fmt(r.baseMultiplicada)}`, pad, y); y+=16;

  doc.setFont('helvetica','bold');
  doc.text(`TOTAL DO OR√áAMENTO: ${fmt(r.total)}`, pad, y); y+=24;

  doc.save('orcamento_ecosmart.pdf');
});
</script>
</body>
</html>
